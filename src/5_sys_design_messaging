
# requirements

* Messaging **must feel instant**, not eventual
* UI updates **before** server ACK
* WebSocket is for **live**, REST for **history**
* Messages are **append-only**, ordered by server
* Presence â‰  messages
* Read receipts are **visibility-based**
* Scroll behavior is **part of correctness**
* Redux store is **normalized**, not nested
* Failure handling matters more than happy path
 
 1ï¸âƒ£ Index / Agenda (One-liner Each)

1. **Problem Definition** â€“ Real-time 1:1 & group messaging
2. **Core Requirements** â€“ Instant UX, reliability, scale
3. **Transport Choice** â€“ Why WebSocket
4. **Connection Lifecycle** â€“ Heartbeats & fallback
5. **Dual Stream Model** â€“ History + live messages
6. **Race Conditions** â€“ Ordering & deduplication
7. **Optimistic UI** â€“ Pending â†’ sent â†’ failed
8. **State Normalization** â€“ Conversations vs messages
9. **Socket Manager** â€“ Single source of truth for WS
10. **Message Store** â€“ Redux-style normalized store
11. **Concurrency Resolver** â€“ Ordering & conflict handling
12. **Presence & Inference** â€“ Online, typing, last seen
13. **Read Receipts** â€“ Seen logic via viewport
14. **Intersection Observer** â€“ Visibility-based signals
15. **Rich Media** â€“ Images, voice, attachments
16. **URL Unfurling** â€“ Link previews via backend
17. **Message UI Components** â€“ Bubble system
18. **Scrolling Model** â€“ Sticky + preserved scroll
19. **Virtualization** â€“ Performance at scale
20. **Failure Scenarios** â€“ Network, retry, resync
21. **End Summary** â€“ Why this architecture scales

---

## 2ï¸âƒ£ Frontend Architecture (Draw This)

```
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚     Messaging UI     â”‚
                  â”‚ (Thread, Composer,   â”‚
                  â”‚  Bubbles, Media)     â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           Viewport Controller          â”‚
        â”‚ (Scroll, Sticky, IntersectionObserver)â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚              Message Store             â”‚
        â”‚   Conversations | Messages | Presence  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ SocketManagerâ”‚ Optimisticâ”‚ Concurrency â”‚
        â”‚ (WS + HB)    â”‚ Updater   â”‚ Resolver    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   WebSocket Layer   â”‚
                  â”‚  (Live Messages)   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ REST APIs (History, Unfurl) â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---



---

## 4ï¸âƒ£ Sticky Notes (Topic-wise)

---

### 1. Problem Definition

**1-liner**
A real-time messaging system where messages feel instant, stay ordered, support rich media, and scale to millions of concurrent users.

---

### 2. Core Requirements

* Instant message send
* Reliable delivery
* Correct ordering
* Online/offline presence
* Read receipts
* Rich media support
* Smooth scrolling
* Scales to large threads

---

### 3. Why WebSocket?

**Why**

* Full duplex
* Low latency
* Server push
* Persistent connection

**Used for**

* Live messages
* Presence updates
* Typing indicators
* Read receipts

---

### 4. WebSocket Lifecycle

* Connect on app open
* Authenticate once
* Heartbeat (ping/pong)
* Reconnect on drop

```
Client â”€â”€ ping â”€â”€> Server
Client <â”€ pong â”€â”€ Server
```

---

### 5. Fallback Strategy

If WS fails:

* Long polling
* Periodic REST fetch

```
WS down â†’ REST sync â†’ WS retry
```

---

### 6. Dual Stream Model (CRITICAL)

**Why**

* History is large
* Live stream is infinite

**Model**

```
REST â†’ Historical Messages
WS   â†’ Live Messages
```

**Rule**

* History loads first
* Live stream appends

---

### 7. Race Conditions

**Problem**

* Message arrives via WS
* Same message appears in REST fetch

**Solution**

* Message IDs
* Deduplication
* Server timestamp ordering

---

### 8. Optimistic UI (Senior Signal)

**Flow**

```
User sends message
â†’ Show instantly (pending)
â†’ Server ACK
â†’ Mark as sent
â†’ On failure â†’ error state
```

States:

* pending
* sent
* failed

---

### 9. Message State Normalization

**Redux Shape**

```
conversations: { id â†’ meta }
messages: { id â†’ message }
conversationMessages: { convId â†’ [msgIds] }
```

Why:

* Fast updates
* No deep nesting
* Easy pagination

---

### ğŸ”Ÿ Socket Manager

**Responsibilities**

* Single WS connection
* Reconnect logic
* Heartbeats
* Fan-out events

**Never**

* Multiple sockets per tab

---

### 1ï¸âƒ£1ï¸âƒ£ Message Store

Holds:

* Messages
* Conversations
* Delivery status
* Presence

Updates from:

* REST
* WebSocket
* Optimistic actions

---

### 1ï¸âƒ£2ï¸âƒ£ Concurrency Resolver

Handles:

* Ordering
* Deduplication
* Late ACKs

Uses:

* Message ID
* Server timestamp
* Local temp ID mapping

---

### 1ï¸âƒ£3ï¸âƒ£ Presence & Inference

Presence states:

* online
* offline
* last seen

Typing indicator:

* Throttled WS events

```
Presence â‰  Message Data
```

---

### 1ï¸âƒ£4ï¸âƒ£ Read Receipts

**How**

* Track message visibility
* Send â€œseenâ€ when visible

**Tool**

* Intersection Observer

```
Message enters viewport
â†’ mark as read
```

---

### 1ï¸âƒ£5ï¸âƒ£ Intersection Observer (Key Usage)

Used for:

* Read receipts
* Lazy media loading
* Performance

Why:

* No scroll listeners
* Efficient

---

### 1ï¸âƒ£6ï¸âƒ£ Rich Media Support

Message types:

* Text
* Image
* Video
* Voice note
* Attachment

Each type:

* Separate renderer
* Shared bubble layout

---

### 1ï¸âƒ£7ï¸âƒ£ URL Unfurling (Link Preview)

**Flow**

```
User pastes URL
â†’ FE sends URL to backend
â†’ Backend fetches OG metadata
â†’ FE renders preview
```

Frontend handles:

* Loading skeleton
* Failure fallback

---

### 1ï¸âƒ£8ï¸âƒ£ Message Bubble System

* Flexible layout
* Content-aware sizing
* Accessibility support

LinkedIn-specific:

* InMail components
* CTA buttons
* Rich cards

---

### 1ï¸âƒ£9ï¸âƒ£ Scrolling Model (Very Important)

Problems:

* New messages arriving
* User scrolling history

Solutions:

* Sticky scroll at bottom
* Preserve scroll when loading history

```
User at bottom â†’ auto-scroll
User scrolling up â†’ preserve position
```

---

### 2ï¸âƒ£0ï¸âƒ£ Virtualization & Windowing

* Render only visible messages
* Prevent DOM explosion
* Works with large threads

---

### 2ï¸âƒ£1ï¸âƒ£ Failure Scenarios

| Scenario      | Handling           |
| ------------- | ------------------ |
| WS drop       | Reconnect + resync |
| Send failure  | Retry / error UI   |
| Duplicate msg | Dedup              |
| Tab refresh   | Restore store      |

---

### 2ï¸âƒ£2ï¸âƒ£ End Summary (Memorize)

**â€œThis architecture separates history from live streams, uses WebSocket for low-latency delivery, applies optimistic updates for instant UX, and ensures correctness through normalization, ordering, and viewport-aware signals like read receipts.â€**

---

If you want next:

* **Whiteboard-only version**
* **Redux reducers & actions sketch**
* **LinkedIn follow-up questions**
* **How recruiters evaluate this answer**

Just say ğŸ‘
